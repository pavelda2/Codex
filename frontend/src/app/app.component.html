<main class="layout">
  <header>
    <h1>Správa receptů</h1>
    <p>Google přihlášení je povinné. Oprávnění zápisu vynucují Firestore Security Rules.</p>

    <div class="auth-row" *ngIf="authLoading(); else authReady">
      <span>Ověřuji přihlášení...</span>
    </div>

    <ng-template #authReady>
      <div class="auth-row" *ngIf="user(); else loggedOut">
        <span>Přihlášen: <strong>{{ user()?.email }}</strong></span>
        <button type="button" class="secondary" (click)="signOut()" [disabled]="authBusy()">Odhlásit</button>
      </div>

      <ng-template #loggedOut>
        <div class="auth-row">
          <span>Pro načtení receptů je potřeba Google přihlášení.</span>
          <button type="button" (click)="signIn()" [disabled]="authBusy()">Přihlásit přes Google</button>
        </div>
      </ng-template>
    </ng-template>
  </header>

  <section class="card">
    <label for="rawText">Raw text receptu (source of truth)</label>
    <textarea id="rawText" [ngModel]="rawText()" (ngModelChange)="rawText.set($event)" rows="16"></textarea>
    <button type="button" (click)="saveRecipe()" [disabled]="saving() || !user()">
      {{ saving() ? 'Ukládám...' : 'Uložit recept' }}
    </button>
    <p class="muted">Pokud nejsi na serverovém whitelistu, zápis bude zamítnut a recepty můžeš jen číst.</p>
  </section>

  <section class="card">
    <h2>Náhled heuristického parsování</h2>
    <h3>{{ parsed().title }}</h3>

    <div *ngFor="let section of parsed().ingredientSections" class="block">
      <h4>{{ section.title }}</h4>
      <ul>
        <li *ngFor="let item of section.items">{{ item }}</li>
      </ul>
    </div>

    <div class="block" *ngIf="parsed().steps.length">
      <h4>Postup</h4>
      <ol>
        <li *ngFor="let step of parsed().steps">{{ step }}</li>
      </ol>
    </div>
  </section>

  <section class="card">
    <h2>Uložené recepty</h2>
    <p *ngIf="!user()">Přihlas se přes Google pro načtení receptů.</p>
    <p *ngIf="user() && loading()">Načítám...</p>
    <p *ngIf="user() && !loading() && recipes().length === 0">Zatím žádné recepty.</p>
    <ul class="recipe-list" *ngIf="user()">
      <li *ngFor="let recipe of recipes()">
        <button type="button" (click)="loadRecipe(recipe)">
          <strong>{{ parsedFromRaw(recipe.raw_text).title }}</strong>
          <small>#{{ recipe.id }}</small>
        </button>
      </li>
    </ul>
  </section>

  <p *ngIf="error()" class="error">{{ error() }}</p>
</main>
