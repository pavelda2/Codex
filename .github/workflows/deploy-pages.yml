name: Deploy frontend to GitHub Pages

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened, closed]
  delete:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: gh-pages
  cancel-in-progress: false

jobs:
  publish-gh-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Resolve publish mode
        id: mode
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action || '' }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name || '' }}
          REPOSITORY: ${{ github.repository }}
          REPOSITORY_OWNER: ${{ github.repository_owner }}
          REPOSITORY_NAME: ${{ github.event.repository.name }}
          DELETED_REF_TYPE: ${{ github.event.ref_type || '' }}
          DELETED_REF: ${{ github.event.ref || '' }}
        run: |
          set -euo pipefail

          mode="none"
          pr_number=""
          delete_branch_ref=""
          public_url=""

          case "$EVENT_NAME" in
            push)
              mode="main_deploy"
              ;;
            pull_request)
              if [[ "$EVENT_ACTION" == "closed" ]]; then
                mode="cleanup"
                pr_number="$PR_NUMBER"
              elif [[ -n "$PR_NUMBER" ]]; then
                if [[ "$PR_HEAD_REPO" == "$REPOSITORY" ]]; then
                  mode="pr_deploy"
                  pr_number="$PR_NUMBER"
                else
                  echo "Fork PR detected ($PR_HEAD_REPO). Skipping preview deploy (no push permission to gh-pages)."
                fi
              fi
              ;;
            delete)
              if [[ "$DELETED_REF_TYPE" == "branch" ]]; then
                mode="cleanup"
                delete_branch_ref="$DELETED_REF"
              fi
              ;;
          esac

          if [[ "$mode" == "main_deploy" ]]; then
            public_url="https://${REPOSITORY_OWNER}.github.io/${REPOSITORY_NAME}/"
          elif [[ "$mode" == "pr_deploy" ]]; then
            public_url="https://${REPOSITORY_OWNER}.github.io/${REPOSITORY_NAME}/pr/${pr_number}/"
          fi

          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
          echo "delete_branch_ref=$delete_branch_ref" >> "$GITHUB_OUTPUT"
          echo "public_url=$public_url" >> "$GITHUB_OUTPUT"

      - name: Show planned Pages URL
        if: steps.mode.outputs.mode == 'main_deploy' || steps.mode.outputs.mode == 'pr_deploy'
        run: |
          echo "Planned publish URL: ${{ steps.mode.outputs.public_url }}"
          {
            echo "### GitHub Pages publish target"
            echo "- Mode: \`${{ steps.mode.outputs.mode }}\`"
            echo "- URL: ${{ steps.mode.outputs.public_url }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: No publish needed
        if: steps.mode.outputs.mode == 'none'
        run: echo "No gh-pages updates required for this event."

      - name: Install frontend dependencies
        if: steps.mode.outputs.mode == 'main_deploy' || steps.mode.outputs.mode == 'pr_deploy'
        working-directory: frontend
        run: npm ci

      - name: Build main site for /<repo>/
        if: steps.mode.outputs.mode == 'main_deploy'
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          npx --yes --prefix frontend ng build --configuration production --base-href "/${REPO_NAME}/"
          mkdir -p .artifacts/main
          cp -a frontend/dist/frontend/. .artifacts/main/

      - name: Build PR preview for /<repo>/pr/<number>/
        if: steps.mode.outputs.mode == 'pr_deploy'
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ steps.mode.outputs.pr_number }}
        run: |
          set -euo pipefail
          npx --yes --prefix frontend ng build --configuration production --base-href "/${REPO_NAME}/pr/${PR_NUMBER}/"
          mkdir -p ".artifacts/pr/${PR_NUMBER}"
          cp -a frontend/dist/frontend/. ".artifacts/pr/${PR_NUMBER}/"

      - name: Prepare gh-pages worktree
        if: steps.mode.outputs.mode != 'none'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin gh-pages || true

          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git worktree add .gh-pages refs/remotes/origin/gh-pages
          else
            git worktree add --detach .gh-pages
            pushd .gh-pages >/dev/null
            git checkout --orphan gh-pages
            git rm -rf . >/dev/null 2>&1 || true
            popd >/dev/null
          fi

      - name: Update gh-pages content
        if: steps.mode.outputs.mode != 'none'
        env:
          MODE: ${{ steps.mode.outputs.mode }}
          PR_NUMBER: ${{ steps.mode.outputs.pr_number }}
          DELETE_BRANCH_REF: ${{ steps.mode.outputs.delete_branch_ref }}
          REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p .gh-pages/pr
          touch .gh-pages/.nojekyll

          if [[ "$MODE" == "main_deploy" ]]; then
            find .gh-pages -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'pr' -exec rm -rf {} +
            cp -a .artifacts/main/. .gh-pages/
            cp .gh-pages/index.html .gh-pages/404.html
          elif [[ "$MODE" == "pr_deploy" ]]; then
            rm -rf ".gh-pages/pr/${PR_NUMBER}"
            mkdir -p ".gh-pages/pr/${PR_NUMBER}"
            cp -a ".artifacts/pr/${PR_NUMBER}/." ".gh-pages/pr/${PR_NUMBER}/"
            cp ".gh-pages/pr/${PR_NUMBER}/index.html" ".gh-pages/pr/${PR_NUMBER}/404.html"
          elif [[ "$MODE" == "cleanup" ]]; then
            prs_to_remove=""

            if [[ -n "$PR_NUMBER" ]]; then
              prs_to_remove="$PR_NUMBER"
            elif [[ -n "$DELETE_BRANCH_REF" ]]; then
              api_url="https://api.github.com/repos/${REPOSITORY}/pulls?state=all&head=${REPOSITORY%%/*}:${DELETE_BRANCH_REF}"
              prs_to_remove="$(curl -fsSL -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "$api_url" | jq -r '.[].number')"
            fi

            if [[ -n "$prs_to_remove" ]]; then
              while IFS= read -r number; do
                [[ -z "$number" ]] && continue
                rm -rf ".gh-pages/pr/${number}"
                echo "Removed preview for PR #${number}"
              done <<< "$prs_to_remove"
            else
              echo "No PR previews to remove."
            fi
          fi

      - name: Commit and push gh-pages
        if: steps.mode.outputs.mode != 'none'
        run: |
          set -euo pipefail
          pushd .gh-pages >/dev/null
          git add -A
          if git diff --cached --quiet; then
            echo "No gh-pages changes to publish."
            popd >/dev/null
            exit 0
          fi
          git commit -m "Publish GitHub Pages (${GITHUB_EVENT_NAME})"
          git push origin HEAD:gh-pages
          popd >/dev/null

      - name: Show published URL
        if: steps.mode.outputs.mode == 'main_deploy' || steps.mode.outputs.mode == 'pr_deploy'
        run: |
          echo "Published: ${{ steps.mode.outputs.public_url }}"
          echo "- Published URL: ${{ steps.mode.outputs.public_url }}" >> "$GITHUB_STEP_SUMMARY"
